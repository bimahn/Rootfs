// =====================================================================
// Developed by Mutiara-Wrt
// Displays internet connection status & public IP information
// =====================================================================

"use strict";"require view";"require form";"require uci";document.head.append(E("style",{type:"text/css"},`:root{--app-id-font-color:#454545;--app-id-font-shadow:#fff;--app-id-connected-color:#6bdebb;--app-id-disconnected-color:#f8aeba;--app-id-undefined-color:#dfdfdf}:root[data-darkmode="true"]{--app-id-font-color:#f6f6f6;--app-id-font-shadow:#4d4d4d;--app-id-connected-color:#005F20;--app-id-disconnected-color:#a93734;--app-id-undefined-color:#4d4d4d}.id-connected{background-color:var(--app-id-connected-color)!important;border-color:var(--app-id-connected-color)!important;color:var(--app-id-font-color)!important;text-shadow:0 1px 1px var(--app-id-font-shadow)}.id-disconnected{background-color:var(--app-id-disconnected-color)!important;border-color:var(--app-id-disconnected-color)!important;color:var(--app-id-font-color)!important;text-shadow:0 1px 1px var(--app-id-font-shadow)}.id-undefined{background-color:var(--app-id-undefined-color)!important;border-color:var(--app-id-undefined-color)!important;color:var(--app-id-font-color)!important;text-shadow:0 1px 1px var(--app-id-font-shadow)}.id-label-status{display:inline-block;margin:2px!important;padding:4px 8px;border:1px solid;border-radius:10px;font-weight:700}`));function getPingStatus(){return fetch("/cgi-bin/ipinfo?ping",{cache:"no-store"}).then((r)=>(r.ok?r.json():{})).catch(()=>({}))}
function getIpInfoFromCgi(){return fetch("/cgi-bin/ipinfo?cekip",{cache:"no-store"}).then((r)=>(r.ok?r.json():{})).catch(()=>({}))}
return view.extend({title:_("Status"),load:function(){return Promise.all([getPingStatus(),getIpInfoFromCgi(),uci.load("ipinfo")])},render:async function(data){let pingData=data[0]||{};let ipinfo=data[1]||{};let cfg={show_ip:uci.get("ipinfo","setting","show_ip"),show_as:uci.get("ipinfo","setting","show_as"),show_isp:uci.get("ipinfo","setting","show_isp"),show_region:uci.get("ipinfo","setting","show_region"),show_city:uci.get("ipinfo","setting","show_city"),show_country:uci.get("ipinfo","setting","show_country"),};let statusClass="id-label-status id-disconnected";let statusText=_("Internet: Disconnected");if(pingData.status&&pingData.status==="success"){statusClass="id-label-status id-connected";statusText=_("Internet: Connected")}
function badge(text,value){let cls="id-label-status id-disconnected";if(value&&value!=="-"){cls="id-label-status id-connected"}
return E("span",{class:cls},_(text)+value)}
var asn=ipinfo.as||"-";var asnum="-";if(asn!=="-"&&/^AS[0-9]+/.test(asn)){asnum=asn.match(/^AS[0-9]+/)[0]}
let ip=ipinfo.query||"-";let isp=ipinfo.isp||ipinfo.org||"-";let region=ipinfo.regionName||"-";let city=ipinfo.city||"-";let country=ipinfo.country||"-";let container=E("div",{class:"cbi-section",style:"margin-bottom:1em"},[E("span",{class:statusClass},statusText)]);if(cfg.show_ip==="1")container.appendChild(badge("IP: ",ip));if(cfg.show_as==="1")container.appendChild(badge("AS: ",asnum));if(cfg.show_isp==="1")container.appendChild(badge("ISP: ",isp));if(cfg.show_region==="1")container.appendChild(badge("Region: ",region));if(cfg.show_city==="1")container.appendChild(badge("City: ",city));if(cfg.show_country==="1")container.appendChild(badge("Country: ",country));let m=new form.Map("ipinfo");let s=m.section(form.NamedSection,"setting","main");s.tab("display",_("Display Settings"));let o;o=s.taboption("display",form.Flag,"show_ip",_("Show Public IP"));o.rmempty=!1;o=s.taboption("display",form.Flag,"show_as",_("Show AS Number"));o.rmempty=!1;o=s.taboption("display",form.Flag,"show_isp",_("Show ISP"));o.rmempty=!1;o=s.taboption("display",form.Flag,"show_region",_("Show Region"));o.rmempty=!1;o=s.taboption("display",form.Flag,"show_city",_("Show City"));o.rmempty=!1;o=s.taboption("display",form.Flag,"show_country",_("Show Country"));o.rmempty=!1;let mapPromise=m.render();mapPromise.then((node)=>{node.classList.add("fade-in");node.prepend(container)});let renderedForm=await m.render();return E("div",{},[container,renderedForm])},})